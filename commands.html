<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Commands</title>
    <!-- Office.js を読み込み -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
</head>
<body>
    <script type="text/javascript">
        // Shared Runtime 用のコマンド関数
        // リボンボタンから呼び出される
        
        // 列番号を列名に変換（0-based）
        function getColumnName(colIndex) {
            var result = '';
            colIndex++; // 1-based に変換
            while (colIndex > 0) {
                colIndex--;
                result = String.fromCharCode(65 + (colIndex % 26)) + result;
                colIndex = Math.floor(colIndex / 26);
            }
            return result;
        }
        
        // CSVインポート機能（リボンコマンド用）
        async function importCsv() {
            try {
                console.log('=== リボンから CSVインポート開始 ===');
                
                // ファイル入力要素を作成
                var fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv,text/csv';
                fileInput.style.display = 'none';
                
                // DOMに追加
                document.body.appendChild(fileInput);
                console.log('ファイル入力要素を作成しました');
                
                // ファイル選択を待つ
                var file = await new Promise(function(resolve, reject) {
                    var timeout = setTimeout(function() {
                        if (document.body.contains(fileInput)) {
                            document.body.removeChild(fileInput);
                        }
                        reject(new Error('ファイル選択がタイムアウトしました'));
                    }, 30000);
                    
                    var cleanup = function() {
                        clearTimeout(timeout);
                        if (document.body.contains(fileInput)) {
                            document.body.removeChild(fileInput);
                        }
                    };
                    
                    fileInput.onchange = function(e) {
                        cleanup();
                        var target = e.target;
                        var file = target.files ? target.files[0] : null;
                        if (file) {
                            console.log('ファイルが選択されました:', file.name);
                            resolve(file);
                        } else {
                            reject(new Error('ファイルが選択されませんでした'));
                        }
                    };
                    
                    fileInput.addEventListener('cancel', function() {
                        cleanup();
                        reject(new Error('ファイル選択がキャンセルされました'));
                    });
                    
                    // 少し遅延を入れてからクリック
                    setTimeout(function() {
                        try {
                            console.log('ファイル選択ダイアログを開きます');
                            fileInput.click();
                            console.log('ファイル選択ダイアログを開きました');
                        } catch (clickError) {
                            cleanup();
                            console.error('ファイル選択ダイアログを開けませんでした:', clickError);
                            reject(new Error('ファイル選択ダイアログを開けませんでした: ' + clickError.message));
                        }
                    }, 100);
                });
                
                // ファイルを読み込み
                console.log('ファイルを読み込み中...');
                var arrayBuffer = await file.arrayBuffer();
                var uint8Array = new Uint8Array(arrayBuffer);
                console.log('ファイルサイズ:', uint8Array.length, 'bytes');
                
                // エンコーディング判定
                var text;
                var encoding;
                
                // UTF-8 BOM判定
                if (uint8Array.length >= 3 && uint8Array[0] === 0xEF && uint8Array[1] === 0xBB && uint8Array[2] === 0xBF) {
                    console.log('UTF-8 BOMを検出');
                    text = new TextDecoder('utf-8').decode(uint8Array.slice(3));
                    encoding = 'UTF-8';
                } else {
                    // UTF-8として試行
                    try {
                        console.log('UTF-8としてデコードを試行');
                        text = new TextDecoder('utf-8', { fatal: true }).decode(uint8Array);
                        encoding = 'UTF-8';
                        console.log('UTF-8としてデコード成功');
                    } catch (e) {
                        console.log('UTF-8デコード失敗、SJISとして試行');
                        // SJISとしてデコード（フォールバック: UTF-8として強制デコード）
                        try {
                            text = new TextDecoder('utf-8', { fatal: false }).decode(uint8Array);
                            encoding = 'UTF-8 (強制)';
                            console.warn('エンコーディング判定に失敗、UTF-8として強制デコード');
                        } catch (sjisError) {
                            console.error('デコード失敗:', sjisError);
                            throw new Error('文字エンコーディングの判定に失敗しました');
                        }
                    }
                }
                
                console.log('デコード完了、文字数:', text.length);
                
                // CSVをパース（簡易実装：改行で分割）
                console.log('CSVをパース中...');
                var lines = text.split(/\r?\n/);
                var rows = [];
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i];
                    if (line.trim() === '') continue; // 空行をスキップ
                    // 簡易CSVパース（カンマで分割、ダブルクォート処理は省略）
                    var cells = line.split(',').map(function(cell) {
                        return cell.trim().replace(/^"|"$/g, '');
                    });
                    rows.push(cells);
                }
                
                console.log('パース完了、行数:', rows.length);
                
                if (rows.length === 0) {
                    throw new Error('CSVファイルが空です');
                }
                
                // 列数の計算
                var colCount = 0;
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].length > colCount) {
                        colCount = rows[i].length;
                    }
                }
                console.log('列数:', colCount);
                
                // Excelに書き込み
                console.log('Excelに書き込み開始');
                await Excel.run(function(context) {
                    var sheet = context.workbook.worksheets.getActiveWorksheet();
                    
                    var rowCount = rows.length;
                    var rangeAddress = 'A1:' + getColumnName(colCount - 1) + rowCount;
                    console.log('範囲アドレス:', rangeAddress);
                    
                    var range = sheet.getRange(rangeAddress);
                    
                    // データを2次元配列に変換
                    var values = [];
                    for (var i = 0; i < rows.length; i++) {
                        var excelRow = [];
                        for (var j = 0; j < colCount; j++) {
                            excelRow.push(rows[i][j] || '');
                        }
                        values.push(excelRow);
                    }
                    
                    console.log('データを設定、行数:', values.length, '列数:', colCount);
                    range.values = values;
                    
                    // テーブル化
                    console.log('テーブルを作成中...');
                    var table = sheet.tables.add(rangeAddress, true);
                    table.name = 'Table_' + Date.now();
                    table.style = 'TableStyleMedium2';
                    
                    return context.sync().then(function() {
                        console.log('Excelへの書き込み完了');
                        console.log('CSVインポート完了 (' + encoding + ', ' + rowCount + '行 x ' + colCount + '列)');
                    });
                });
                
                console.log('=== CSVインポート完了 ===');
            } catch (error) {
                console.error('=== CSVインポートエラー ===');
                console.error('エラー:', error);
                var errorMessage = error instanceof Error ? error.message : String(error);
                console.error('エラーメッセージ:', errorMessage);
                // エラーを再スロー（Officeアドイン環境では alert が使えない）
                throw error;
            }
        }
        
        // グローバル関数としてエクスポート（manifest.xml の FunctionName と一致）
        // ExecuteFunction アクションで呼び出される
        if (typeof window !== 'undefined') {
            window.importCsv = importCsv;
            console.log('importCsv 関数を登録しました');
        }
        
        // Office.js の初期化
        Office.onReady(function(info) {
            if (info.host === Office.HostType.Excel) {
                console.log('Commands.html: Office.js 初期化完了');
                console.log('importCsv 関数:', typeof window.importCsv);
                
                // Shared Runtime の場合、actions.associate で登録
                if (Office.context.requirements.isSetSupported('SharedRuntime')) {
                    console.log('Shared Runtime がサポートされています');
                    if (Office.actions && Office.actions.associate) {
                        Office.actions.associate('importCsv', importCsv);
                        console.log('importCsv を actions.associate で登録しました');
                    }
                }
            }
        });
        
        console.log('Commands.html: スクリプト読み込み完了');
    </script>
</body>
</html>

