<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Commands</title>
    <!-- Office.js を読み込み -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
</head>
<body>
    <script type="text/javascript">
        // Shared Runtime 用のコマンド関数
        // リボンボタンから呼び出される
        
        // 列番号を列名に変換（0-based）
        function getColumnName(colIndex) {
            var result = '';
            colIndex++; // 1-based に変換
            while (colIndex > 0) {
                colIndex--;
                result = String.fromCharCode(65 + (colIndex % 26)) + result;
                colIndex = Math.floor(colIndex / 26);
            }
            return result;
        }
        
        // CSVインポート機能（リボンコマンド用）
        async function importCsv() {
            try {
                console.log('=== リボンから CSVインポート開始 ===');
                
                // ファイル入力要素を作成
                var fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv,text/csv';
                fileInput.style.display = 'none';
                
                // DOMに追加
                document.body.appendChild(fileInput);
                console.log('ファイル入力要素を作成しました');
                
                // ファイル選択を待つ
                var file = await new Promise(function(resolve, reject) {
                    var timeout = setTimeout(function() {
                        if (document.body.contains(fileInput)) {
                            document.body.removeChild(fileInput);
                        }
                        reject(new Error('ファイル選択がタイムアウトしました'));
                    }, 30000);
                    
                    var cleanup = function() {
                        clearTimeout(timeout);
                        if (document.body.contains(fileInput)) {
                            document.body.removeChild(fileInput);
                        }
                    };
                    
                    fileInput.onchange = function(e) {
                        cleanup();
                        var target = e.target;
                        var file = target.files ? target.files[0] : null;
                        if (file) {
                            console.log('ファイルが選択されました:', file.name);
                            resolve(file);
                        } else {
                            reject(new Error('ファイルが選択されませんでした'));
                        }
                    };
                    
                    fileInput.addEventListener('cancel', function() {
                        cleanup();
                        reject(new Error('ファイル選択がキャンセルされました'));
                    });
                    
                    // 少し遅延を入れてからクリック
                    setTimeout(function() {
                        try {
                            console.log('ファイル選択ダイアログを開きます');
                            fileInput.click();
                            console.log('ファイル選択ダイアログを開きました');
                        } catch (clickError) {
                            cleanup();
                            console.error('ファイル選択ダイアログを開けませんでした:', clickError);
                            reject(new Error('ファイル選択ダイアログを開けませんでした: ' + clickError.message));
                        }
                    }, 100);
                });
                
                // ファイルを読み込み
                console.log('ファイルを読み込み中...');
                var arrayBuffer = await file.arrayBuffer();
                var uint8Array = new Uint8Array(arrayBuffer);
                console.log('ファイルサイズ:', uint8Array.length, 'bytes');
                
                // エンコーディング判定
                var text;
                var encoding;
                
                // UTF-8 BOM判定
                if (uint8Array.length >= 3 && uint8Array[0] === 0xEF && uint8Array[1] === 0xBB && uint8Array[2] === 0xBF) {
                    console.log('UTF-8 BOMを検出');
                    text = new TextDecoder('utf-8').decode(uint8Array.slice(3));
                    encoding = 'UTF-8';
                } else {
                    // UTF-8として試行
                    try {
                        console.log('UTF-8としてデコードを試行');
                        text = new TextDecoder('utf-8', { fatal: true }).decode(uint8Array);
                        encoding = 'UTF-8';
                        console.log('UTF-8としてデコード成功');
                    } catch (e) {
                        console.log('UTF-8デコード失敗、SJISとして試行');
                        // SJISとしてデコード（フォールバック: UTF-8として強制デコード）
                        try {
                            text = new TextDecoder('utf-8', { fatal: false }).decode(uint8Array);
                            encoding = 'UTF-8 (強制)';
                            console.warn('エンコーディング判定に失敗、UTF-8として強制デコード');
                        } catch (sjisError) {
                            console.error('デコード失敗:', sjisError);
                            throw new Error('文字エンコーディングの判定に失敗しました');
                        }
                    }
                }
                
                console.log('デコード完了、文字数:', text.length);
                
                // CSVをパース（簡易実装：改行で分割）
                console.log('CSVをパース中...');
                var lines = text.split(/\r?\n/);
                var rows = [];
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i];
                    if (line.trim() === '') continue; // 空行をスキップ
                    // 簡易CSVパース（カンマで分割、ダブルクォート処理は省略）
                    var cells = line.split(',').map(function(cell) {
                        return cell.trim().replace(/^"|"$/g, '');
                    });
                    rows.push(cells);
                }
                
                console.log('パース完了、行数:', rows.length);
                
                if (rows.length === 0) {
                    throw new Error('CSVファイルが空です');
                }
                
                // 列数の計算
                var colCount = 0;
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].length > colCount) {
                        colCount = rows[i].length;
                    }
                }
                console.log('列数:', colCount);
                
                // Excelに書き込み
                console.log('Excelに書き込み開始');
                await Excel.run(function(context) {
                    var sheet = context.workbook.worksheets.getActiveWorksheet();
                    
                    var rowCount = rows.length;
                    var rangeAddress = 'A1:' + getColumnName(colCount - 1) + rowCount;
                    console.log('範囲アドレス:', rangeAddress);
                    
                    var range = sheet.getRange(rangeAddress);
                    
                    // データを2次元配列に変換
                    var values = [];
                    for (var i = 0; i < rows.length; i++) {
                        var excelRow = [];
                        for (var j = 0; j < colCount; j++) {
                            excelRow.push(rows[i][j] || '');
                        }
                        values.push(excelRow);
                    }
                    
                    console.log('データを設定、行数:', values.length, '列数:', colCount);
                    range.values = values;
                    
                    // テーブル化
                    console.log('テーブルを作成中...');
                    var table = sheet.tables.add(rangeAddress, true);
                    table.name = 'Table_' + Date.now();
                    table.style = 'TableStyleMedium2';
                    
                    return context.sync().then(function() {
                        console.log('Excelへの書き込み完了');
                        console.log('CSVインポート完了 (' + encoding + ', ' + rowCount + '行 x ' + colCount + '列)');
                    });
                });
                
                console.log('=== CSVインポート完了 ===');
            } catch (error) {
                console.error('=== CSVインポートエラー ===');
                console.error('エラー:', error);
                var errorMessage = error instanceof Error ? error.message : String(error);
                console.error('エラーメッセージ:', errorMessage);
                // エラーを再スロー（Officeアドイン環境では alert が使えない）
                throw error;
            }
        }
        
        // 消費種類自動設定機能（リボンコマンド用）
        async function setConsumptionCategory() {
            try {
                console.log('=== リボンから 消費種類自動設定開始 ===');
                
                // type.csvを読み込んでconsumptionMapを構築
                var response = await fetch('/type.csv');
                if (!response.ok) {
                    throw new Error('type.csvの読み込みに失敗しました');
                }
                var text = await response.text();
                
                // 簡易CSVパース（ヘッダー行をスキップして、カンマで分割）
                var lines = text.split(/\r?\n/);
                var consumptionMap = new Map();
                
                // 1行目はヘッダーなのでスキップ（2行目から処理）
                for (var i = 1; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line) continue; // 空行をスキップ
                    
                    // カンマで分割（簡易実装、ダブルクォート処理は省略）
                    var cells = line.split(',');
                    if (cells.length >= 2) {
                        var keyword = cells[0].trim();
                        var type = cells[1].trim();
                        if (keyword && type) {
                            consumptionMap.set(keyword, type);
                        }
                    }
                }
                
                console.log('consumptionMapを構築しました: ' + consumptionMap.size + '件のマッピング');
                
                if (consumptionMap.size === 0) {
                    throw new Error('type.csvに有効なマッピングがありません');
                }
                
                // Excel処理
                await Excel.run(function(context) {
                    var sheet = context.workbook.worksheets.getActiveWorksheet();
                    
                    // 使用範囲を取得して最終行を特定
                    var usedRange = sheet.getUsedRange();
                    usedRange.load(['rowCount', 'rowIndex']);
                    
                    return context.sync().then(function() {
                        var startRow = 4; // 4行目から開始（1-based）
                        var endRow = usedRange.rowIndex + usedRange.rowCount - 1; // 最終行（1-based）
                        
                        if (endRow < startRow) {
                            console.log('処理対象の行がありません');
                            return;
                        }
                        
                        console.log('処理範囲: ' + startRow + '行目〜' + endRow + '行目');
                        
                        // B列とK列のデータを一括取得（4行目から最終行まで）
                        var bColumnRange = sheet.getRange('B' + startRow + ':B' + endRow);
                        var kColumnRange = sheet.getRange('K' + startRow + ':K' + endRow);
                        
                        bColumnRange.load('values');
                        kColumnRange.load('values');
                        
                        return context.sync().then(function() {
                            var bValues = bColumnRange.values;
                            var kValues = kColumnRange.values;
                            
                            // 新しいK列の値を構築
                            var newKValues = [];
                            var matchedCount = 0;
                            
                            for (var i = 0; i < bValues.length; i++) {
                                var bValue = String(bValues[i][0] || '').trim();
                                var currentKValue = kValues[i][0];
                                
                                // B列が空の場合はスキップ（K列は変更しない）
                                if (!bValue) {
                                    newKValues.push([currentKValue]);
                                    continue;
                                }
                                
                                // consumptionMapの各キー（キーワード）がB列文字列に部分一致するかチェック
                                var matchedType = null;
                                for (var entry of consumptionMap.entries()) {
                                    var keyword = entry[0];
                                    var type = entry[1];
                                    if (bValue.includes(keyword)) {
                                        matchedType = type;
                                        matchedCount++;
                                        break; // 最初にマッチしたキーを使用
                                    }
                                }
                                
                                // マッチした場合は新しい値を設定、マッチしない場合は既存の値を維持
                                if (matchedType !== null) {
                                    newKValues.push([matchedType]);
                                } else {
                                    newKValues.push([currentKValue]);
                                }
                            }
                            
                            // K列に一括書き込み
                            if (matchedCount > 0) {
                                kColumnRange.values = newKValues;
                                return context.sync().then(function() {
                                    console.log('消費種類自動設定完了: ' + matchedCount + '件のマッチ');
                                });
                            } else {
                                console.log('マッチするキーワードが見つかりませんでした');
                            }
                        });
                    });
                });
                
                console.log('=== 消費種類自動設定完了 ===');
            } catch (error) {
                console.error('=== 消費種類自動設定エラー ===');
                console.error('エラー:', error);
                var errorMessage = error instanceof Error ? error.message : String(error);
                console.error('エラーメッセージ:', errorMessage);
                // エラーを再スロー
                throw error;
            }
        }
        
        // グローバル関数としてエクスポート（manifest.xml の FunctionName と一致）
        // ExecuteFunction アクションで呼び出される
        if (typeof window !== 'undefined') {
            window.importCsv = importCsv;
            window.setConsumptionCategory = setConsumptionCategory;
            console.log('importCsv 関数を登録しました');
            console.log('setConsumptionCategory 関数を登録しました');
        }
        
        // Office.js の初期化
        Office.onReady(function(info) {
            if (info.host === Office.HostType.Excel) {
                console.log('Commands.html: Office.js 初期化完了');
                console.log('importCsv 関数:', typeof window.importCsv);
                console.log('setConsumptionCategory 関数:', typeof window.setConsumptionCategory);
                
                // Shared Runtime の場合、actions.associate で登録
                if (Office.context.requirements.isSetSupported('SharedRuntime')) {
                    console.log('Shared Runtime がサポートされています');
                    if (Office.actions && Office.actions.associate) {
                        Office.actions.associate('importCsv', importCsv);
                        Office.actions.associate('setConsumptionCategory', setConsumptionCategory);
                        console.log('importCsv を actions.associate で登録しました');
                        console.log('setConsumptionCategory を actions.associate で登録しました');
                    }
                }
            }
        });
        
        console.log('Commands.html: スクリプト読み込み完了');
    </script>
</body>
</html>

